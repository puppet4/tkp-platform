name: API Tests

on:
  push:
    branches: ["**"]
  pull_request:

jobs:
  api-http-tests-sqlite:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Setup uv
        uses: astral-sh/setup-uv@v5

      - name: Run API smoke
        run: |
          set -euo pipefail
          mkdir -p artifacts
          TEST_HTTP_MODE=sqlite TKP_TEST_LOG=1 TKP_TEST_LOG_VERBOSE=1 TKP_TEST_LOG_PAYLOAD=0 \
            bash scripts/test_api_smoke.sh | tee artifacts/api-smoke.log

      - name: Run API permissions matrix
        run: |
          set -euo pipefail
          TEST_HTTP_MODE=sqlite TKP_TEST_LOG=1 TKP_TEST_LOG_VERBOSE=1 TKP_TEST_LOG_PAYLOAD=0 \
            bash scripts/test_api_permissions_matrix.sh | tee artifacts/api-permissions-matrix.log

      - name: Run API full
        run: |
          set -euo pipefail
          TEST_HTTP_MODE=sqlite TKP_TEST_LOG=1 TKP_TEST_LOG_VERBOSE=1 TKP_TEST_LOG_PAYLOAD=0 \
            bash scripts/test_api_full_coverage.sh | tee artifacts/api-full.log

      - name: Upload API test logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: api-test-logs-sqlite
          path: artifacts/*.log
          if-no-files-found: warn

  api-http-tests-postgres:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    services:
      postgres:
        image: docker.io/pgvector/pgvector:pg16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: tkp_api_test
        ports:
          - 55432:5432
        options: >-
          --health-cmd "pg_isready -U postgres -d tkp_api_test"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10
      redis:
        image: docker.io/library/redis:7
        ports:
          - 56379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Setup uv
        uses: astral-sh/setup-uv@v5

      - name: Wait database ready
        run: |
          set -euo pipefail
          for _ in $(seq 1 60); do
            if pg_isready -h 127.0.0.1 -p 55432 -U postgres -d tkp_api_test; then
              exit 0
            fi
            sleep 1
          done
          echo "postgres not ready in time" >&2
          exit 1

      - name: Apply SQL schema
        env:
          PGPASSWORD: postgres
        run: |
          set -euo pipefail
          for f in \
            infra/sql/000_extensions.sql \
            infra/sql/010_tables.sql \
            infra/sql/020_indexes.sql \
            infra/sql/030_comments.sql \
            infra/sql/040_seed_permissions.sql
          do
            echo "apply: $f"
            psql -h 127.0.0.1 -p 55432 -U postgres -d tkp_api_test -v ON_ERROR_STOP=1 -f "$f"
          done

      - name: Run API full on Postgres
        run: |
          set -euo pipefail
          mkdir -p artifacts
          TEST_HTTP_MODE=postgres TKP_TEST_LOG=1 TKP_TEST_LOG_VERBOSE=1 TKP_TEST_LOG_PAYLOAD=0 \
            bash scripts/test_api_full_coverage.sh | tee artifacts/api-full-postgres.log

      - name: Upload Postgres API test logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: api-test-logs-postgres
          path: artifacts/*.log
          if-no-files-found: warn
